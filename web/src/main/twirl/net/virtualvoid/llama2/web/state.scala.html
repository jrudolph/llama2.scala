@import net.virtualvoid.llama2._
@import web._

@(state: Llama2State)

<h2>@{state.model.name}</h2>

<div class="generation">
@for(step <- state.stateHistory.dropRight(1)) {<span><a style="color: @{Colors.GreenToRed.colorFor(step.chosenTokenProb)};" title="P: @{step.chosenTokenProb.formatted("%7.4f")} Rank: @{step.chosenTokenRank}" href="/prompt?tokens=@{step.stateHistory.map(_.chosenToken).mkString(",")}">@{step.chosenTokenText}</a></span>}
</div>

<h4>Continue</h4>

<div>
  <div><a href="/generate?method=topp&n=20&tokens=@{state.stateHistory.dropRight(1).map(_.chosenToken).mkString(",")}">Generate 20 more with Temperature 1 and top-p = 0.9f</a></div>
  <div><a href="/generate?method=argmax&n=20&tokens=@{state.stateHistory.dropRight(1).map(_.chosenToken).mkString(",")}">Generate 20 more with greedy search</a></div>
</div>

<h4>Attention (in this step)</h4>
<table>
  <tr style="font-size: smaller">
    <th>Layer</th><th>Head</th><th>&lt;s&gt;</th>
@for(step <- state.stateHistory.dropRight(1)) {
    <th class="generation"><a href="/prompt?tokens=@{step.stateHistory.map(_.chosenToken).mkString(",")}">@{step.chosenTokenText}</a></th>
}
  </tr>
@for(Attention(l, h, att) <- state.attention) {
  <tr>
    <td>@{l}</td>
    <td>@{h}</td>
    @for(v <- att.toFloatArray) {
      <td style="background-color: @{Colors.AttentionColoring.colorFor(v)}">@{v.formatted("%5.2f")}</td>
    }
  </tr>
}
</table>

<h4>Top completions</h4>
<table>
  <tr><th>Logit value</th><th>Prob</th><th>Cum. Prob.</th><th>ID</th><th>-- Token --</th>
    <td class="vmap">@for(c <- state.classifier.toFloatArray){<span style="background-color: @{Colors.Classifier.colorFor(c)}"></span>}</td>

  </tr>
@for(
  x <- Seq(1);
  ps = { val res = Tensor1DMut(state.logits.toArray.clone(), state.logits.size); res.softmaxMut(); res };
  (ll, token, p, cum) <- state.logits.zipWithIndex.sortBy(-_._1).take(100).map(x => (x._1, x._2, ps(x._2))).scanLeft((0f, 0, 0f, 0f))((a, b) => (b._1, b._2, b._3, b._3 + a._4)).drop(1)
) {
  <tr>
    <td>@{ll.formatted("%7.4f")}</td><td style="color: @{Colors.GreenToRed.colorFor(p)}">@{p.formatted("%7.4f")}</td><td style="background-color: @{Colors.WhiteToBlue.colorFor(cum - p)}">@{cum.formatted("%7.4f")}</td><td>@{token}</td>
    <td><a href="/prompt?tokens=@{(state.stateHistory.dropRight(1).map(_.chosenToken) :+ token).mkString(",")}">@{state.model.vocab.tokenScores(token)._1}</a></td>
    <td class="vmap">@for(x <- Seq(1); vs = { val res = Tensor1DMut.zero(state.model.config.dim); res := state.model.weights.wcls(token); res âˆ˜= state.classifier; res.toFloatArray }; v <- vs){<span style="background-color: @{Colors.ClassifierMatch.colorFor(v)}"></span>}</td>
  </tr>
}
</table>